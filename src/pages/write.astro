---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Writing Studio - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
		<style>
			main {
				width: 720px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 3em 1em;
			}
			.editor-container {
				display: flex;
				flex-direction: column;
				gap: 1.5rem;
			}
			input, select, textarea {
				width: 100%;
				padding: 0.8rem;
				border: 1px solid #eee;
				border-radius: 4px;
				background-color: #fff;
				font-family: inherit;
				font-size: 1rem;
				outline: none;
				transition: border-color 0.2s;
			}
			input:focus, select:focus, textarea:focus {
				border-color: #ccc;
			}
			.title-input {
				font-size: 2.5rem;
				font-weight: 700;
				border: none;
				padding: 0;
				background-color: transparent;
			}
			.title-input::placeholder {
				color: #eee;
			}
			.content-area {
				min-height: 400px;
				resize: none;
				border: none;
				padding: 0;
				background-color: transparent;
				line-height: 1.6;
				font-size: 1.1rem;
			}
			.actions {
				display: flex;
				justify-content: flex-end;
				margin-top: 2rem;
			}
			.publish-btn {
				background-color: #1a1a1a;
				color: white;
				padding: 0.8rem 2rem;
				border-radius: 2rem;
				border: none;
				font-weight: 600;
				cursor: pointer;
				transition: opacity 0.2s;
			}
			.publish-btn:hover {
				opacity: 0.8;
			}
			.publish-btn:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}
			#status {
				margin-top: 1rem;
				font-size: 0.9rem;
				text-align: right;
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<div class="editor-container">
				<input type="text" id="title" placeholder="제목을 입력하세요" class="title-input" />
				<div style="display: flex; gap: 1rem;">
					<select id="category" style="width: auto;">
						<option value="daily">Daily</option>
						<option value="medical">Medical</option>
						<option value="dev">Dev</option>
						<option value="misc">Misc</option>
					</select>
					<input type="text" id="description" placeholder="짧은 요약 (선택 사항)" style="border: none; border-bottom: 1px solid #eee; border-radius: 0;" />
				</div>
				<textarea id="content" placeholder="이곳에 정갈한 기록을 남겨보세요..." class="content-area"></textarea>
				<div class="actions">
					<button id="publish" class="publish-btn">발행하기</button>
				</div>
				<p id="status"></p>
			</div>
		</main>
		<Footer />

		<script>
			const publishBtn = document.getElementById('publish') as HTMLButtonElement;
			const titleInput = document.getElementById('title') as HTMLInputElement;
			const contentInput = document.getElementById('content') as HTMLTextAreaElement;
			const categoryInput = document.getElementById('category') as HTMLSelectElement;
			const descriptionInput = document.getElementById('description') as HTMLInputElement;
			const statusMsg = document.getElementById('status');

			publishBtn.addEventListener('click', async () => {
				const title = titleInput.value;
				const content = contentInput.value;
				const category = categoryInput.value;
				const description = descriptionInput.value;

				if (!title || !content) {
					alert('제목과 내용을 입력해주세요.');
					return;
				}

				publishBtn.disabled = true;
				if (statusMsg) statusMsg.textContent = '저장 중...';

				try {
					const response = await fetch('/api/posts', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ title, content, category, description })
					});

					const result = await response.json();

					if (response.ok) {
						if (statusMsg) {
							statusMsg.textContent = '성공적으로 저장되었습니다! 1분 내외로 사이트에 반영됩니다.';
							statusMsg.style.color = 'green';
						}
						// Clear inputs
						titleInput.value = '';
						contentInput.value = '';
						descriptionInput.value = '';
					} else {
						throw new Error(result.message);
					}
				} catch (error) {
					if (statusMsg) {
						statusMsg.textContent = '저장 오류: ' + (error as Error).message;
						statusMsg.style.color = 'red';
					}
				} finally {
					publishBtn.disabled = false;
				}
			});

			// Auto-resize textarea
			contentInput.addEventListener('input', () => {
				contentInput.style.height = 'auto';
				contentInput.style.height = contentInput.scrollHeight + 'px';
			});
		</script>
	</body>
</html>
